generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SessionStatus {
  PLANNED
  COMPLETED
  CANCELLED
}

model UserProfile {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique @db.Uuid
  age             Int?
  goal            String   @default("balanced")
  experienceLevel String   @default("beginner")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  progressionState ProgressionState?
  readinessEntries ReadinessEntry[]
  sessions         WorkoutSession[]
  userProgram      UserProgram?
  weeklyPlanSeeds  WeeklyPlanSeed[]
}

model UserProgram {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @unique @db.Uuid
  goal        String   @default("balanced")
  daysPerWeek Int      @default(4)
  active      Boolean  @default(true)
  startDate   DateTime @db.Date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userProfile UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model ReadinessEntry {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  date       DateTime @db.Date
  sleepHours Int
  energy     Int
  soreness   Int
  stress     Int
  notes      String?
  createdAt  DateTime @default(now())

  userProfile UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, date])
}

model ProgressionState {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @unique @db.Uuid
  strengthLevel Int      @default(3)
  volumeLevel   Int      @default(3)
  fatigueScore  Int      @default(0)
  deloadCount   Int      @default(0)
  updatedAt     DateTime @updatedAt

  userProfile UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Exercise {
  id              String   @id
  name            String
  category        String
  movementPattern String
  muscleGroup     String
  equipment       String
  difficulty      Int      @default(1)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessionResults SessionResult[]
}

model WorkoutSession {
  id            String        @id @default(uuid()) @db.Uuid
  userId        String        @db.Uuid
  sessionDate   DateTime      @db.Date
  engineVersion String
  snapshot      Json
  status        SessionStatus @default(PLANNED)
  createdAt     DateTime      @default(now())
  submittedAt   DateTime?

  userProfile UserProfile     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  results     SessionResult[]

  @@index([userId, sessionDate])
}

model SessionResult {
  id            String   @id @default(uuid()) @db.Uuid
  sessionId     String   @db.Uuid
  exerciseId    String
  plannedSets   Int
  plannedReps   Int
  completedSets Int
  completedReps Int
  rpe           Float
  createdAt     DateTime @default(now())

  session  WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Restrict)

  @@index([sessionId])
}

model WeeklyPlanSeed {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  weekStart DateTime
  seed      Int
  updatedAt DateTime @updatedAt

  userProfile UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
}
